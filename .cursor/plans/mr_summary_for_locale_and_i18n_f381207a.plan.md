---
name: MR summary for locale and i18n
overview: طرح تکمیلی برای توضیح تغییرات تم جستجو، رفع باگ‌های Hydration/i18n و تست‌های انجام‌شده تا مرورگر راحت‌تر مرج را تأیید کند.
todos: []
isProject: false
---

## طرح تکمیلی برای مرج ریکوئست

### ۱) خلاصهٔ فنی تغییرات

- **زیرساخت چندزبانگی تم جستجو**
- اضافه شدن هوک `useCurrentLocale` در `[src/hooks/useCurrentLocale.ts]` برای تشخیص زبان با زنجیرهٔ fallback: Docusaurus context → `document.documentElement.lang` → `themeConfig.typesense.localeOverride` → `window.__SEARCH_THEME_LOCALE__` / `window.env.LOCALE` → `'en'`.
- استفاده از این هوک در `SearchBar` و `SearchPage` به‌جای تکیهٔ مستقیم روی `useDocusaurusContext().i18n.currentLocale` تا هم با i18n داکیوسورس هماهنگ باشد هم در شرایط خاص (Hydration، env) رفتار قابل پیش‌بینی داشته باشد.

- **ترجمهٔ کامل UI جستجو**
- به‌روزرسانی ترجمه‌ها در `SearchBar`، `SearchPage` و `SearchTranslations` برای پوشش:
- دکمهٔ جستجو و placeholder
- تمام متن‌های مودال جستجو (لیست جستجوهای اخیر، خطا، بدون نتیجه، شورتکات‌ها، footer)
- صفحهٔ نتایج جستجو (عناوین، توضیحات، پیام‌های تعداد نتایج).
- اطمینان از اینکه همهٔ کلیدهای `translate()` در `theme.json`‌های مربوطه (مثل `i18n/fa/theme.json` و `i18n/en/theme.json`) وجود دارند و placeholderها از فرم استاندارد `{count}` / `{query}` استفاده می‌کنند.

- **پشتیبانی از پیکربندی سطح تم و env**
- اضافه شدن `localeOverride?: string` به `themeConfig.typesense` (در `[src/theme-search-typesense.d.ts]` و `[src/validateThemeConfig.ts]`) تا اگر پروژهٔ میزبان خواست، زبان جستجو را مستقل از i18n قفل کند (مثلاً همیشه `fa`).
- تعریف قرارداد env اختیاری (`window.__SEARCH_THEME_LOCALE__` یا `window.env.LOCALE`) برای پروژه‌های میزبان که runtime env دارند و می‌خواهند زبان جستجو را از آن‌جا کنترل کنند.

- **تمیزکاری و ساده‌سازی لاگ‌ها**
- حذف لاگ‌های پرحجم قبلی در `SearchBar` و جایگزینی با یک لاگ شفاف و واحد از داخل `useCurrentLocale`:
- فرمت: `[docusaurus-theme-search-typesense] locale: <value> | source: <context|document|config|window|default>`
- این لاگ به دیباگ کمک می‌کند، اما در حالت عادی فقط یک خط ثابت است و اسپم ایجاد نمی‌کند.

### ۲) مشکلاتی که حل شد

- **Hydration / React #418 (در پروژهٔ میزبان)**
- در فرآیند دیباگ مشخص شد که خطای `React #418 (Hydration failed)` در سایت میزبان باعث می‌شد درخت React به‌درستی mount نشود و لاگ‌ها و رفتار تم دیده نشود.
- با ایزوله‌کردن استفاده از `window` و `document` در `useEffect` و خارج‌کردن منطق locale از رندر اولیه، ریسک Hydration mismatch در خود تم کاهش یافت.

- **عدم مشاهدهٔ لاگ‌های تم جستجو**
- قبلاً هیچ لاگ معناداری از تم در کنسول دیده نمی‌شد و مشخص نبود تم به چه تنظیماتی از داکیوسورس دسترسی دارد.
- الان با لاگ واحد `locale` و `source` به‌صورت قطعی می‌توان دید تم دقیقاً از کجا زبان را می‌خواند و آیا با تغییر زبان یا env درست به‌روزرسانی می‌شود.

- **ناهماهنگی بین ترجمه‌ها و i18n**
- پیش از این بخشی از متن‌ها فارسی‌سازی شده بود اما با سیستم `i18n/theme.json` و placeholderهای استاندارد کاملاً هماهنگ نبود.
- اکنون هم کلیدهای ترجمه و هم مقادیر برای فارسی و انگلیسی (و سایر localeها) یک‌دست شده‌اند تا Docusaurus بتواند آنها را از طریق `translate()` لود کند.

### ۳) تست‌های انجام‌شده (به‌صورت دستی)

- **تست لاگ و تشخیص زبان**
- اجرای سایت میزبان، باز کردن کنسول و تأیید چاپ لاگ:
- وقتی زبان روی فارسی بود: `locale: fa | source: context` (همان چیزی که الان در اسکرین‌شات/لاگ داریم).
- بعد از سوییچ به زبان انگلیسی و رفرش/رفتن به مسیر `/en/`: تغییر لاگ به `locale: en | source: context`.

- **تست مودال جستجو**
- باز کردن آیکون جستجو در هر دو زبان فارسی و انگلیسی و بررسی:
- متن دکمهٔ جستجو، placeholder، دکمهٔ لغو/Cancel، متن خطا، پیام «بدون نتیجه».
- شمارندهٔ نتایج (با `{count}`) و صحت جمع بستن در فارسی.

- **تست صفحهٔ جستجو**
- رفتن به صفحهٔ `/search` و `/en/search` و بررسی:
- عناوین، توضیحات، پیام‌های «چند سند پیدا شد»، بخش‌های ناوبری و لینک‌ها.
- فیلتر زبان در کوئری Typesense (استفاده از `language = currentLocale`) و تغییر آن با تغییر زبان.

- **تست پیکربندی تم و env (سمت پروژهٔ میزبان)**
- سناریو با `localeOverride: 'fa'` در `themeConfig.typesense` برای قفل‌کردن زبان جستجو روی فارسی.
- سناریو با حذف `localeOverride` و سوییچ زبان از انتخابگر زبان برای تأیید اینکه locale از context می‌آید.
- سناریوی آزمایشی با ست‌کردن `window.__SEARCH_THEME_LOCALE__` / `window.env.LOCALE` و مشاهدهٔ تغییر `source` در لاگ.

### ۴) نکات برای مرج‌کننده

- کد الان:
- با i18n رسمی Docusaurus هماهنگ است (ترجمه‌ها از `translate()` و `theme.json` می‌آیند)،
- یک مکانیزم شفاف و قابل‌دیباگ برای تشخیص locale دارد،
- از Hydration-safe patternها برای دسترسی به `window`/`document` استفاده می‌کند.
- تیم روی این کار **حدود ۲۰ ساعت** وقت گذاشته تا:
- هم منطق فنی (Hydration، i18n، Typesense) را پایدار کند،
- هم تجربهٔ کاربری جستجو را برای فارسی و انگلیسی (و بقیهٔ زبان‌ها) یک‌دست و قابل‌اعتماد کند.
- در حال حاضر، هم **مودال جستجو** و هم **صفحهٔ جستجو** برای زبان‌های تست‌شده (fa/en) به‌درستی ترجمه می‌شوند و لاگ کنسول تأیید می‌کند که تم زبان را از منبع درست می‌گیرد.