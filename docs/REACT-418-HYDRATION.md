# خطای React #418 و ارتباط با تم جستجو

## خطای #418 یعنی چه؟

**React Error #418 = Hydration failed**

یعنی خروجی HTML که روی **سرور** رندر شده با خروجی اولیه‌ای که React روی **کلاینت** می‌سازد یکی نیست. React انتظار دارد در مرحلهٔ hydration دقیقاً همان درخت DOM را ببیند که سرور فرستاده؛ اگر فرق داشته باشد این خطا را می‌دهد.

## چرا ممکن است لاگ تم جستجو را نبینیم؟

وقتی Hydration با خطا مواجه شود:

- React سعی می‌کند با یک رندر مجدد (recover) خودش را درست کند.
- ممکن است بعضی کامپوننت‌ها دوباره mount شوند یا در وضعیت عجیبی باشند.
- اگر چانک تم جستجو بعد از این خطا لود شود یا درخت کامپوننت عوض شده باشد، ممکن است `useEffect` داخل SearchBar هرگز اجرا نشود یا لاگ در کنسول گم شود.

پس **اول باید خطای Hydration را برطرف کنید**؛ بعد احتمال دیده شدن لاگ تم جستجو بیشتر می‌شود.

## علت‌های معمول Hydration در پروژهٔ شما

از لاگ‌های شما این‌ها برمی‌آید:

1. **استفاده از `window.env` در حین رندر**
   - لاگ `[Root] New Typesense config from window.env` یعنی جایی در کامپوننت Root (یا والد) در **حین رندر** از `window.env` استفاده می‌شود.
   - روی **سرور** `window` وجود ندارد یا مقدارش فرق دارد؛ روی **کلاینت** مقدار دیگری است.
   - اگر بر اساس این مقدار چیزی رندر شود (مثلاً یک `div` یا متن متفاوت)، سرور و کلاینت خروجی متفاوت می‌دهند و خطای #418 رخ می‌دهد.

2. **ساختار HTML نامعتبر**
   - در componentStack خطا آمده: `at div` و `at p`.
   - اگر جایی داخل یک `<p>` یک المان بلاک (مثلاً `<div>`) رندر شود، در HTML معتبر نیست و مرورگر DOM را عوض می‌کند؛ در نتیجه سرور و کلاینت با هم جور نمی‌شوند.

## کارهایی که باید انجام دهید

### ۱) پیدا کردن محل دقیق خطا (توسعه با بیلد غیر مینیفای)

در پروژهٔ داکیوسورس (مثلاً kasra-docs):

- به‌جای `npm run build` + `npm run serve`، یک بار با **حالت توسعه** اجرا کنید:
  - `npm run start`
- در مرورگر همان صفحه را باز کنید و خطا را ببینید.
- در حالت توسعه پیام خطای React کامل است و معمولاً می‌گوید کدام کامپوننت و کدام prop/children باعث اختلاف شده است.

### ۲) اصلاح استفاده از `window.env`

هر جایی که در **حین رندر** (بدون `useEffect`) از `window` یا `window.env` استفاده می‌کنید و بر اساس آن JSX عوض می‌شود:

- آن قسمت را به **بعد از mount شدن** موکول کنید:
  - یا با `useEffect` + یک state (مثلاً `configFromWindow`) که فقط روی کلاینت ست می‌شود،
  - یا با یک کامپوننت که فقط روی کلاینت رندر می‌شود (مثلاً با چک `typeof window !== 'undefined'` داخل یک state که در `useEffect` true می‌شود).
- هدف: در **اولین رندر** سرور و کلاینت دقیقاً همان خروجی را بدهند؛ استفاده از `window` فقط بعد از hydration (مثلاً داخل `useEffect`) باشد.

### ۳) بررسی تگ‌های تو در تو

در کامپوننت‌هایی که در componentStack خطا هستند (مثلاً اطراف آن `div` و `p`):

- مطمئن شوید داخل `<p>` فقط محتوای phrasing (مثل متن، `<span>`) دارید، نه `<div>` یا کامپوننت‌هایی که در نهایت `<div>` رندر می‌کنند.

### ۴) بعد از رفع Hydration

- دوباره بیلد و سرور را اجرا کنید و در کنسول مرورگر دنبال این لاگ‌ها بگردید:
  - `[docusaurus-theme-search-typesense] SearchBar module loaded`
  - `[docusaurus-theme-search-typesense] i18n values from Docusaurus context:`

اگر خطای #418 برطرف شده باشد و تم جستجو از گیت‌هاب درست نصب شده باشد، این لاگ‌ها باید دیده شوند.

## خلاصه

| موضوع | توضیح |
|--------|--------|
| خطای #418 | Hydration failed – عدم تطابق رندر سرور و کلاینت |
| تأثیر روی لاگ تم | ممکن است چانک/کامپوننت تم درست mount نشود یا useEffect اجرا نشود |
| احتمال زیاد در پروژه شما | استفاده از `window.env` در حین رندر در Root یا اطراف آن |
| اقدام | ۱) `npm run start` و دیدن پیام کامل خطا ۲) بردن استفاده از `window` به بعد از hydration (مثلاً useEffect) ۳) رفع هر گونه `<div>` داخل `<p>` |

---

**نکته:** در خود این تم (`docusaurus-theme-search-typesense`) از `window` فقط در event handlerها یا وقتی مودال باز است (فقط روی کلاینت) استفاده شده است، بنابراین منبع خطای #418 معمولاً در **سایت داکیوسورس شما** (مثلاً Root یا جایی که `window.env` را در حین رندر می‌خوانید) است.
